;/*FB_PKG_DELIM*/

__d("createReStoreIndexedDbPersistenceWithoutLocks",["ClientConsistency","CurrentMessengerUser","Deferred","ExecutionEnvironment","FBLogger","LSPlatformErrorChannel","LSPlatformLsInitLog","MAWCryptoConsts","MAWKeychainNaClCrypto","MWEARKeychainV3","MessengerLogHistory","ReStoreBinaryEncoding","ReStoreDbClosedError","ReStoreDbConfigStore","ReStoreDbVersionChange","ReStoreDecryptionFailure","ReStoreErrorAction","ReStorePersistence","err","pageID","promiseDone","promiseFromRequest","tweetnacl","unrecoverableViolation"],(function(a,b,c,d,e,f,g){"use strict";var h,i=d("CurrentMessengerUser").getIDorEIMU(),j=d("MessengerLogHistory").getInstance("db_init"),k=new Set([d("ReStoreDbConfigStore").CONFIG_STORE_NAME]),l=new(d("ReStoreBinaryEncoding").Encoder)(),m=new(d("ReStoreBinaryEncoding").Decoder)();function n(a,b){if(a==null)return null;var e=new Uint8Array(a);try{e=e[1];var f=d("MWEARKeychainV3").getDbEncryptionKey(e);f=f.key;var g=3;a=d("tweetnacl").secretbox.open(new Uint8Array(a,g+d("tweetnacl").secretbox.nonceLength),new Uint8Array(a,g,d("tweetnacl").secretbox.nonceLength),new Uint8Array(f));if(a==null){throw new(d("MAWKeychainNaClCrypto").EARDecryptionError)("Encrypted dexie was unable to decrypt an entity. Attempting to use key version : "+((g=e)!=null?g:"non-provided")+".")}return m.decode(a)}catch(a){c("LSPlatformErrorChannel").emit(new(d("ReStoreDecryptionFailure").ReStoreDecryptionFailure)(a.message,b));throw new(d("ReStoreDecryptionFailure").ReStoreDecryptionFailure)(a.message,b)}}function o(a,b){if(a==null)return a;try{var e=d("MWEARKeychainV3").getDbEncryptionKey(),f=e.key;e=e.version;e=new Uint8Array([0,e,d("MAWCryptoConsts").CIPHER_ID]);var g=d("tweetnacl").randomBytes(d("tweetnacl").secretbox.nonceLength);a=d("tweetnacl").secretbox(l.encode(a),g,new Uint8Array(f));f=new Uint8Array(e.length+g.length+a.length);f.set(e);f.set(g,e.length);f.set(a,e.length+g.length);return f.buffer}catch(a){throw c("err")(a.message+" - Encrypted LSDB was unable to encrypt an entity for table "+b)}}function p(a){for(a of a.values())if(a.size!==0)return!1;return!0}function q(a,b){var c=[];a=new Set(a);for(var d of a)b.objectStoreNames.contains(d)||c.push(d);d=[];for(var e=0;e<b.objectStoreNames.length;e++){var f=b.objectStoreNames[e];!a.has(f)&&!k.has(f)&&d.push(f)}if(c.length!==0||d.length!==0)return[c,d]}function r(a,b){if(b==null){j.debug("Schema doesn't have changes to apply");return}j.debug("Schema has changes to apply");var c=b[0];b=b[1];c.forEach(function(b){a.objectStoreNames.contains(b)||a.createObjectStore(b,{autoIncrement:!0})});b.forEach(function(b){a.objectStoreNames.contains(b)&&a.deleteObjectStore(b)})}function s(a,b,e,f){function g(a){e(a.target),j.debug("DB onversionchange TABID="+c("pageID")),c("FBLogger")("mpf_web_foundations").info("[pdb] onversionchange inWorker=%s",String((h||(h=c("ExecutionEnvironment"))).isInWorker)),d("LSPlatformLsInitLog").fail("version_change"),c("LSPlatformErrorChannel").emit(new(d("ReStoreDbVersionChange").ReStoreDbVersionChange)())}return new Promise(function(e,h){var i=indexedDB.open(a,f);i.onupgradeneeded=function(a){a=a.target;var c=a.result;a=a.transaction;b(c,a)};i.onerror=function(a){d("LSPlatformLsInitLog").fail("failed_to_open_pdb"),h(c("unrecoverableViolation")("Failed to open db","messenger_web_product",{error:a.target.error}))};i.onsuccess=function(a){a=a.target.result;a.addEventListener("versionchange",g);e(a)}})}async function t(a,b,e,f){function g(a){d("LSPlatformLsInitLog").addAnnotations({bool:{dbEmpty:!0}});d("ReStoreDbConfigStore").createDbConfig(a,f.defaultConfig);for(var c of b)a.createObjectStore(c,{autoIncrement:!0})}d("LSPlatformLsInitLog").addPoint("idb_open_start");var i=await s(a,g,e);d("LSPlatformLsInitLog").addPoint("idb_open_end");var k=i.transaction(d("ReStoreDbConfigStore").CONFIG_STORE_NAME,"readonly");k=await Promise.all([d("ReStoreDbConfigStore").detectConfigMismatch(k,f),d("ReStoreDbConfigStore").readCorruptionFailuresFromConfig(k).then(function(a){return(a=a==null?void 0:a.value)!=null?a:0})]);var l=k[0];k=k[1];var m=k>0;m&&(c("FBLogger")("mpf_web_foundations").info("[pdb] opening corrupted db failures=%s inWorker=%s",String(k),String((h||(h=c("ExecutionEnvironment"))).isInWorker)),j.debug("DB corrupted, deleting db"));l&&j.debug("DB config mismatch, deleting db");d("LSPlatformLsInitLog").addAnnotations({bool:{configMismatch:l,dbCorruptionOccured:m}});if(l||m){i.close();(k=d("LSPlatformLsInitLog")).addPoint("delete_db_start");await c("promiseFromRequest")(indexedDB.deleteDatabase(a));k.addPoint("delete_db_end");k.addPoint("re_open_db_start");i=await s(a,g,e);k.addPoint("re_open_db_end")}else{var n=q(b,i);n!=null&&(j.debug("Schema mismatch, bumping db version"),i.close(),d("LSPlatformLsInitLog").addPoint("schema_mismatch_bump_version_start"),i=await s(a,function(a){return r(a,n)},e,i.version+1),d("LSPlatformLsInitLog").addPoint("schema_mismatch_bump_version_end"))}return i}function a(a,b,e){var f=i+"-"+a,g=!0,h,k=[],l=!1,m=Promise.resolve();j.debug("PDB is ON");d("LSPlatformLsInitLog").addPoint("init_idb_start");var q=new Map(),r=new Promise(function(d,f){c("promiseDone")(m=m.then(async function(){try{var c=await t(a,b,u,e);d(c)}catch(a){f(a)}}),function(a){},function(a){return c("FBLogger")("mpf_web_foundations").catching(a).warn("[pdb] dbLock idbPromise issue")})});c("promiseDone")(r.then(function(){d("LSPlatformLsInitLog").addPoint("init_idb_end")}));function u(a){a.close(),g=!1}function v(a,b,c){return a.transaction(c!=null&&c.length>0?c:a.objectStoreNames,b,{durability:"relaxed"})}function w(a){var b=q.get(a);b==null&&(b=new Map(),q.set(a,b));return b}function x(a){function b(a){var b=v(a,"readonly");b.onabort=function(){h===b&&(h=null)};h=b}return new Promise(async function(c,d){k.push(function(b){return a(b).then(c)});var e=await r;if(h==null)try{b(e)}catch(a){return d(a)}if(!l){l=!0;while(k.length){e=k;k=[];await Promise.all(e.map(function(a){return a(h)}))}l=!1;(d=h)==null?void 0:d.commit==null?void 0:d.commit();h=null}})}async function y(){var a;if(!g)return;var b=(a=(a=await x(function(a){return d("ReStoreDbConfigStore").readCorruptionFailuresFromConfig(a)}))==null?void 0:a.value)!=null?a:0;c("promiseDone")(r,async function(a){a=v(a,"readwrite");await d("ReStoreDbConfigStore").writeCorruptionFailuresToConfig(a,b)})}function z(){c("promiseDone")(r,function(a){u(a)})}function A(){if(!g)throw new(c("ReStoreDbClosedError"))()}async function B(a){await r;A();var b=c("ClientConsistency").getAdditionalRevisions();b.size>0&&(c("FBLogger")("mpf_web_foundations").info("[pdb] js mismatch detected"),d("ReStoreErrorAction").softRefresh());return new Promise(function(b,d){c("promiseDone")(m=m.then(async function(){try{var c=await a();b(c)}catch(a){d(a)}}),function(a){},function(a){return c("FBLogger")("mpf_web_foundations").catching(a).warn("[pdb] dbLock runExclusively issue")})})}return{clearCache:function(){q.clear()},close:z,flush:async function(b,e){e=e.upgrade;if(!g)return;async function f(a){var c=new Promise(function(b,c){a.oncomplete=function(a){b(a.target.result)},a.onerror=a.onabort=function(a){q.clear(),c(a)}}),e=!1;for(var f of b){var g=f[0],h=f[1],i=a.objectStore(g);for(h of h){var j=h[0],k=h[1],l;if(k===d("ReStorePersistence").sentinelDeleted)l=i.delete(j);else{k=o(k,g);l=i.put(k,j)}l.onerror=function(){return e=!0}}}e?a.abort():a.commit!=null&&a.commit();await c}function i(){Array.from(b).forEach(function(a){var b=a[0];a=a[1];var c=w(b);Array.from(a).forEach(function(a){var b=a[0];a=a[1];a===d("ReStorePersistence").sentinelDeleted?c.delete(b):c.set(b,a)})})}if(p(b))return;var j=await r;if(e===!0){c("FBLogger")("mpf_web_foundations").info("[pdb] Updating IDB version, fromVersion: %s, non-empty tables: %s",j.version,Array.from(b.entries()).filter(function(a){a[0];a=a[1];return a.size>0}).map(function(a){a=a[0];return a}).sort().toString());(e=h)==null?void 0:e.abort();j.close();q.clear();r=async function(){var b=new(c("Deferred"))(),d=await s(a,function(a,d){i(),c("promiseDone")(f(d),function(){b.resolve()},function(){b.reject()})},u,j.version+1);await b.getPromise();return d}();await r;return}if(b.size===0)return;i();e=Array.from(b.keys());e.push(d("ReStoreDbConfigStore").CONFIG_STORE_NAME);await f(v(j,"readwrite",e))},get:function(a,b,d){var e=w(b);if(e.has(d))return e.get(d);else{if(!g)return new Promise(function(){});var f=x(function(a){return c("promiseFromRequest")(a.objectStore(b).get(d))}).then(function(a){var c=e.get(d);if(c!==f)return c;c=n(a,b);e.set(d,c);return c});e.set(d,f);return f}},isClosed:function(){return!g},logError:function(a,b,d,e){if(d==="dbCorruption"){b==="readwrite"&&c("promiseDone")(y());throw c("FBLogger")("mpf_web_foundations").mustfixThrow("Got unexpected undefined in pdb, mode: %s, table: %s, id: %s, deletedInThisTxn: %s",b,a,(d=e==null?void 0:e.id)!=null?d:"",(b=e==null?void 0:e.deletedInThisTxn)!=null?b:"")}},queueCommitWork:function(a){return a()},runExclusively:B,shouldApplySync:function(){return!1},shouldSync:function(a,b){return!1},types:["indexeddb"],uniqueId:f}}a.schemaDiff=q;a.applyChanges=r;g.default=a}),98);
__d("MAWDbThread",["MAWHexUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return d("MAWHexUtils").orderPreservingHex(a)+"_"+b}g.craftThreadOrder=a}),98);
__d("MAWDexieTable",["Promise","dexie_maw"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){return(h||(h=b("Promise"))).resolve(a)}function a(a){return a.reduce(function(a,b,c){return a.then(function(a){return b(c).then(function(b){a.push(b);return a})})},m([]))}function e(a){return c("dexie_maw").Promise.all(a)}function f(a){return c("dexie_maw").Promise.PSD[a]}function j(a,b){c("dexie_maw").Promise.PSD[a]=b}function k(a){c("dexie_maw").Promise.PSD[a]=void 0}var l=function(){function a(a,b,d,e){d===void 0&&(d=!0);e=new(c("dexie_maw"))(a,babelHelpers["extends"]({chromeTransactionDurability:"relaxed"},e));b(e);this.name=a;this.stores=e;d&&this.open()}var b=a.prototype;b.open=function(){this.stores.open()};b.close=function(){this.stores.close()};b.transact=function(a,b,c){var d=this;return i(this.stores.transaction(a,b.map(function(a){return d.stores[a]}),function(){return c()}))};babelHelpers.createClass(a,[{key:"tables",get:function(){return this.stores.tables}}]);return a}();function m(a){return c("dexie_maw").Promise.resolve(a)}function n(a){return c("dexie_maw").waitFor(a)}g.DEXIE_MIN_KEY=d("dexie_maw").Dexie.minKey;g.DEXIE_MAX_KEY=d("dexie_maw").Dexie.maxKey;g.dexieSequentialAll=a;g.dexieAll=e;g.getDexiePSDItem=f;g.setDexiePSDItem=j;g.clearDexiePSDItem=k;g.DexieTable=l;g.dexieResolve=m;g.dexieExpensiveAwait=n}),98);
__d("MAWDbSchema",["MAWDbMsg","MAWDbThread","MAWDexieTable","MAWFolderTypes","MAWLocalizationType","MAWMsgType","MAWODSProxy","MAWTimeUtils","MAWWaitForBackendSetup","SignalDbTypes","WAJids","WAOdsEnums","WAStanzaUtils","WATimeUtils","dexie_maw","gkx","promiseDone","unrecoverableViolation"],(function(a,b,c,d,e,f,g){"use strict";a={appData:"++appDataId,&externalId",appMeta:"key",browserEncryptionMeta:"++id, &version",chunk:"++chunkId, &hashedPlaintextHash",contacts:"contactJid",existingUsers:"id",ftsBackloggedMessages:"rowId",ftsEncryptionMeta:"key",ftsIndexV3:"++ftsRowId,id,chatId,*prefixes",groupInfo:"groupJid,threadId",identity:"deviceJid",jobs:"++jobId,&uniqKey",media:"++mediaId, &hashedPlaintextHash, *msgIds",messages:"++rowId,externalId,thread,msgId,altIndex,messageExpirationTs,messageDeleteTs,quoteExternalId",meta:"key",participants:"id,threadId,userJid",pendingReceipts:"id",pendingStanzas:"++rowId,externalIdWithType",personalSenderKeyStatuses:"groupJid",prekey:"keyId",prekeyGeneration:"generationId",reactions:"++rowId,reactionId,externalId,reactToMsgId,threadJid,reactToExternalId",receipts:"msgId",senderKeySessions:"id,groupJid,userJid",session:"id",signedPrekey:"keyId",tasks:"taskName",threads:"++chatId,&jid,threadOrder",unrenderedMessages:"++rowId,externalId,thread,msgId"};b={messages:"++rowId,externalId,thread,msgId,altIndex,messageExpirationTs,messageDeleteTs,quoteExternalId,unsendMsgContentDeleteTs"};e={messages:"++rowId,externalId,thread,msgId,altIndex,messageExpirationTs,messageDeleteTs,quoteExternalId,unsendMsgContentDeleteTs,revokedExternalId"};f={isDualSend:"++rowId"};var h={historySyncQRCodeSecretKey:"key"},i={unrenderedMessages:"++rowId,externalId,thread,msgId,messageDeleteForMeTs"},j={messages:"++rowId,externalId,thread,msgId,altIndex,messageExpirationTs,messageDeleteTs,quoteExternalId,unsendMsgContentDeleteTs,revokedExternalId,threadJid",unrenderedMessages:"++rowId,externalId,thread,msgId,messageDeleteForMeTs,threadJid"},k={groupInvites:"invitedParticipantId, inviterJid"},l={pendingStanzas:"++rowId,externalIdWithType, deleteTs"},m={media:"++mediaId, &hashedPlaintextHash, *msgIds, &objectId, &fbid"},n={dualSendMedia:"++id"},o={xma:"++xmaId, associatedMessageId, faviconMediaId, headerMediaId, targetExpiringAtSec, defaultPreviewMediaId"},p={historySyncQRCodeData:"rowId"},q={xma:"++xmaId, externalId, associatedMessageId, faviconMediaId, headerMediaId, targetExpiringAtSec, defaultPreviewMediaId"},r={dyiBatch:"++batchId"},s={groupInfo:"groupJid,threadId,correspondingOpenThreadKey"},t=null;t={groupInvites:t};var u={groupInvites:"[invitedParticipantId+inviterJid], inviterJid"},v={messages:"++rowId,externalId,thread,msgId,altIndex,messageExpirationTs,messageDeleteTs,quoteExternalId,unsendMsgContentDeleteTs,revokedExternalId,threadJid,[thread+sortOrderMs]",unrenderedMessages:"++rowId,externalId,thread,msgId,messageDeleteForMeTs,threadJid,[thread+sortOrderMs]"},w={syncActions:"index,collection,actionState,indexMac,action,[modelId+modelType+actionState]"},x={missingKeys:"keyHex"},y={pendingMutations:"++id,action,index,collection"},z={collectionVersions:"++id,&collection"},A={syncKeys:"++id,&keyId,keyEpoch"},B={identity:"deviceJid,userJid"},C={uploadRetryStatus:"[externalId+lastRetryTs], lastRetryTs, traceId"},D={stanzaQueue:"++stanzaQueueId,stanzaId,jid,type"},E={deviceChangeAlerts:"++deviceChangeAlertsId"},F={retroactiveBackupsState:"threadId"},G={threads:"++chatId,&jid,threadOrder,&deduplicationKey"},H={mediaBackup:"++mediaBackupId,&objectId,mediaId,msgId"},I={threads:"++chatId,&jid,threadOrder,&deduplicationKey,&authoritativeThreadKey"},J={stanzaQueue:"++stanzaQueueId,stanzaId,jid,type,[jid+type]"},K={editMsgHistory:"++editMsgHistoryId,originalMsgExternalId,threadJid"},L={ftsBackloggedMessages:null,ftsEncryptionMeta:null,ftsIndexV3:null},M={media:"++mediaId, &hashedPlaintextHash, *msgIds, objectId, fbid"},N={ebRestoreQueue:"++queueId",ebUploadQueue:"++queueId"},O={ebRestoreQueue:"++queueId, uploadStatus, uploadTsSec, [uploadStatus+uploadTsSec]",ebUploadQueue:"++queueId, uploadStatus, uploadTsSec, [uploadStatus+uploadTsSec]"},P={messages:"++rowId,externalId,thread,msgId,altIndex,messageExpirationTs,messageDeleteTs,quoteExternalId,unsendMsgContentDeleteTs,revokedExternalId,threadJid,[thread+sortOrderMs],[thread+serverTs]"},Q={jobs:null},R={danglingQueue:"++queueId"},S={staleQueue:"++staleQueueId,dbVersion"},T={ebUploadQueue:"++queueId, uploadStatus, uploadTsSec, msgIdKey, offlineThreadingId, backupActionType, [uploadStatus+uploadTsSec], [msgIdKey], [offlineThreadingId+backupActionType]"},U={ftsBackloggedMessages:"rowId",ftsEncryptionMeta:"key",ftsIndexV3:"++ftsRowId,id,chatId,*prefixes"},V={participants:"id,threadId,userJid,[threadJid+userJid]"},W=function(a){var b=function(a){var b;b=(b=a.quote)==null?void 0:b.content;return a.quoteExternalId!=null&&(b==null?void 0:b.media)!=null};return a.messages.where("quoteExternalId").between(d("WAStanzaUtils").toStanzaId("0"),d("WAStanzaUtils").toStanzaId("["),!0,!0).filter(b).toArray()["catch"](function(){return a.messages.filter(b).toArray()}).then(function(b){var c=new Set(b.map(function(a){a=(a=a.quote)==null?void 0:a.content;return a==null?void 0:(a=a.media)==null?void 0:a.plaintextHash}).filter(Boolean)),d=b.map(function(a){a=a.msgId;return a});return a.media.filter(function(a){a=a.plaintextHash;return c.has(a)}).toArray().then(function(b){var c=new Map(b.map(function(a){var b=a.mediaId;a=a.plaintextHash;return[a,b]}));return a.messages.where("msgId").anyOf(d).modify(function(a){var b;b=(b=a.quote)==null?void 0:b.content;a.quote.content.mediaId=c.get(b.media.plaintextHash);delete a.quote.content.media})})})},X=function(a){return a.groupInfo.toCollection().modify(function(a){typeof a.inviter==="number"&&delete a.inviter})},Y=function(a){return a.meta.get(d("SignalDbTypes").MetaKeysEnum.deviceId).then(function(b){var c;if((b==null?void 0:(c=b.value)==null?void 0:c.deviceId)!=null&&typeof b.value.deviceId!=="number")return a.meta.clear()})},Z=function(a){return a.threads.filter(function(a){return d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(){return!1},user:function(){return a.oldestMsg!=null}})}).toArray().then(function(b){var c=[];b.forEach(function(a){c.push(a.oldestMsg),c.push(a.newestMsg)});return a.messages.where("msgId").anyOf(c.filter(Boolean)).toArray().then(function(c){var e=new Map(),f=[],g=[];c.forEach(function(a){e.set(a.msgId,a)});b.forEach(function(b){var c=e.get(b.oldestMsg),h=e.get(b.newestMsg);(c==null?void 0:c.type)==="Admin"&&(h==null?void 0:h.type)==="Admin"&&(c.msgId===h.msgId?g.push(b.chatId):f.push(b));return d("MAWDexieTable").dexieAll(f.map(function(b){return a.messages.where("thread").equals(b.chatId).toArray()})).then(function(b){b.forEach(function(a){if(a.length===0)return;var b=a[0].thread;a=a.filter(function(a){return a.type!=="Admin"});if(a.length>0)return;g.push(b)});return d("MAWDexieTable").dexieAll([a.threads.bulkDelete(g),a.messages.where("thread").anyOf(g)["delete"]()])})})})})},$=function(a){return a.unrenderedMessages.toCollection().modify(function(a){if(a.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME){var b=a.messageDeleteForMeTs;a.messageDeleteForMeTs=b}})},aa=function(a){var b=0,e=0,f=c("dexie_maw").currentTransaction;if(f==null)throw c("unrecoverableViolation")("transaction does not exist","messenger_e2ee_web");f.on("complete",function(){c("promiseDone")(d("MAWWaitForBackendSetup").waitForBackendSetup("DB upgrade to V31").then(function(){b>0&&d("MAWODSProxy").odsBumpEntityKey({amount:b,entity:d("WAOdsEnums").Entity.MESSAGE_MISSING_THREAD_JID,key:"fail"}),e>0&&d("MAWODSProxy").odsBumpEntityKey({amount:e,entity:d("WAOdsEnums").Entity.MESSAGE_MISSING,key:"fail"})}))});f.on("complete",function(){b>0&&d("MAWODSProxy").odsBumpEntityKey({amount:b,entity:d("WAOdsEnums").Entity.MESSAGE_MISSING_THREAD_JID,key:"fail"}),e>0&&d("MAWODSProxy").odsBumpEntityKey({amount:e,entity:d("WAOdsEnums").Entity.MESSAGE_MISSING,key:"fail"})});return a.threads.toArray().then(function(c){var f=c.reduce(function(a,b){b!=null&&a.set(b.chatId,b);return a},new Map());return d("MAWDexieTable").dexieAll([a.messages.toCollection().modify(function(a){if(a!=null){var c=f.get(a.thread);c!=null?a.threadJid=c.jid:b+=1}else e+=1}),a.unrenderedMessages.toCollection().modify(function(a){if(a!=null){var c=f.get(a.thread);c!=null?a.threadJid=c.jid:b+=1}else e+=1})])})},ba=function(a){return a.isDualSend.toCollection().modify(function(a){a.version==null&&(a.version=1)})},ca=function(a){return a.messages.toCollection().modify(function(a){a.type===d("MAWMsgType").MSG_TYPE.ADMIN&&a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION&&(a.altIndex=d("MAWDbMsg").craftE2eeAdminMsgAltIndex(a.thread))})},da=function(a){return a.messages.toCollection().modify(function(a){a.sortOrderMs=d("MAWDbMsg").getSortOrderWithFallback(a)})},ea=function(a){return a.threads.toCollection().modify(function(a){a.folder==null&&(a.folder=d("MAWFolderTypes").FOLDER_ID.INBOX)})},fa=function(a){return a.messages.toCollection().modify(function(a){a.sortOrderMs=d("MAWDbMsg").getSortOrderWithFallback(a)})},ga=function(a){return a.personalSenderKeyStatuses.toCollection().modify(function(a){a.rotateSenderKey=!0,a.hasSenderKey=new Set()})},ha=function(a){return a.messages.toCollection().modify(function(a){a.type===d("MAWMsgType").MSG_TYPE.ADMIN&&a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_THREAD_ADMIN_MESSAGE&&a.sortOrderMs!=null&&a.sortOrderMs>0&&(a.sortOrderMs=0)})},ia=function(a){return a.messages.toCollection().modify(function(a){!(a.type===d("MAWMsgType").MSG_TYPE.ADMIN&&(a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_THREAD_ADMIN_MESSAGE||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION))&&a.sortOrderMs!=null&&a.sortOrderMs<1661204086&&(a.sortOrderMs=d("MAWDbMsg").getCanonicalTsFromMsg(a)*1e3)})},ja=function(a){return a.threads.filter(function(a){return a.isMigratedLocally===!0&&a.newestMsg!=null}).toArray().then(function(b){var c=b.map(function(a){return a.chatId}),e=new Map();return d("MAWDexieTable").dexieAll(b.map(function(b){return a.messages.where(["thread","sortOrderMs"]).between([b.chatId,0],[b.chatId,Number.MAX_VALUE]).last().then(function(a){a!=null&&e.set(a.thread,a.msgId)})})).then(function(){return a.threads.where("chatId").anyOf(c).modify(function(a){var b=e.get(a.chatId);b!=null&&(a.newestMsg=b)})})})},ka=function(a){return a.identity.toCollection().modify(function(a){a.userJid=d("WAJids").extractUserJid(a.deviceJid)})},la=function(a){return a.threads.toCollection().modify(function(a){a.lastReadMsgTs!=null&&a.lastReadMsgTs<d("WATimeUtils").MAX_INT&&(a.lastReadMsgTs=d("MAWTimeUtils").ensureValidMillisTime(a.lastReadMsgTs));if(a.newestMsgTs!=null&&a.newestMsgTs<d("WATimeUtils").MAX_INT){var b=d("MAWTimeUtils").ensureValidMillisTime(a.newestMsgTs);a.newestMsgTs=b;b!=null&&(a.threadOrder=d("MAWDbThread").craftThreadOrder(b,a.jid))}})},ma=function(a){return a.messages.toCollection().modify(function(a){a.type===d("MAWMsgType").MSG_TYPE.ADMIN&&a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_THREAD_ADMIN_MESSAGE&&(a.altIndex=d("MAWDbMsg").craftCutoverAdminMsgAltIndex(a.thread))})},na=function(a){return a.meta.get(d("SignalDbTypes").MetaKeysEnum.fbid).then(function(b){var c;if((b==null?void 0:(c=b.value)==null?void 0:c.fbid)!=null&&b.value.fbid==="0")return a.meta.clear()})},oa=function(a){return a.prekey.filter(function(a){return a.isDeleted===!0})["delete"]()},pa=function(a){return c("gkx")("3178")?a.meta.clear():d("MAWDexieTable").dexieResolve()},qa=function(a){return a.participants.toCollection().modify(function(a){var b;if(a==null||((b=a.userJid)==null?void 0:b.indexOf("@msgr@msgr"))===!1)return;a.id=a.id.replace("@msgr@msgr","@msgr");a.userJid=a.userJid.replace("@msgr@msgr","@msgr")}).then(function(){})},ra=function(a){var b=a.threads.filter(function(a){return a.snippetMsg!=null&&a.snippetMsgTs==null});return b.toArray().then(function(c){var e=c.reduce(function(a,b){b!=null&&b.snippetMsg!=null&&a.set(b.jid,b.snippetMsg);return a},new Map());c=Array.from(e.values());return a.messages.where("msgId").anyOf(c).toArray().then(function(a){var c=a.reduce(function(a,b){b!=null&&b.serverTs!=null&&a.set(b.msgId,b.serverTs);return a},new Map());b.modify(function(a){var b=e.get(a.jid);if(b!=null){b=c.get(b);b!=null&&(a.snippetMsgTs=d("WATimeUtils").castUnixTimeToMillisTime(b))}})})})},sa=function(a){return a.threads.toArray().then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){return a.participants.where("threadId").equals(b.chatId).modify(function(a){a.threadJid=(a=a.threadJid)!=null?a:b.jid})}))})};a=[{schema:a,version:21},{schema:b,version:22},{schema:e,version:23},{schema:f,version:24},{schema:h,version:25},{upgrade:W,version:26},{upgrade:X,version:27},{upgrade:Y,version:28},{upgrade:Z,version:29},{schema:i,upgrade:$,version:30},{schema:j,upgrade:aa,version:31},{schema:k,version:32},{schema:l,version:33},{schema:m,version:34},{schema:n,version:35},{schema:o,version:36},{schema:p,version:37},{schema:q,version:38},{schema:r,version:39},{schema:s,version:40},{schema:t,version:41},{schema:u,version:42},{upgrade:ba,version:43},{upgrade:ca,version:44},{schema:v,upgrade:da,version:45},{upgrade:ea,version:46},{upgrade:fa,version:47},{schema:w,version:48},{schema:x,version:49},{schema:y,version:50},{schema:z,version:51},{schema:A,version:52},{upgrade:ga,version:53},{upgrade:ha,version:54},{upgrade:ia,version:55},{upgrade:ja,version:56},{schema:B,upgrade:ka,version:57},{upgrade:la,version:58},{schema:C,version:59},{upgrade:ma,version:60},{schema:D,version:61},{schema:E,version:62},{schema:F,version:63},{schema:G,version:64},{schema:H,version:65},{upgrade:na,version:66},{schema:I,version:67},{upgrade:oa,version:68},{schema:J,version:69},{schema:K,version:70},{upgrade:pa,version:71},{upgrade:qa,version:72},{schema:L,version:73},{schema:M,version:74},{schema:N,version:75},{schema:O,version:77},{schema:P,version:78},{schema:Q,version:79},{schema:R,version:80},{schema:S,version:81},{upgrade:ra,version:82},{schema:T,version:83},{schema:U,version:84},{schema:V,upgrade:sa,version:85}];b=["messages","unrenderedMessages","groupInfo","meta","identity","prekey","prekeyGeneration","session","signedPrekey","senderKeySessions","receipts","pendingReceipts","threads","contacts","participants","tasks","personalSenderKeyStatuses","appData","appMeta","chunk","mediaBackup","media","reactions","groupInvites","dyiBatch","syncActions","missingKeys","pendingMutations","collectionVersions","syncKeys","deviceChangeAlerts","xma","retroactiveBackupsState","editMsgHistory"];g.MAW_DB_VERSION_CHANGES=a;g.TABLES_TO_ENCRYPT=b}),98);
__d("MAWDbVersion",["MAWDbSchema","MAWRestoreRewriteUtils","Promise","WALogger","qex"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[DB] version is not set in QE"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[DB] maybe version: ",""]);j=function(){return a};return a}function k(){return c("qex")._("285")}function l(a){return d("MAWDbSchema").MAW_DB_VERSION_CHANGES.filter(function(b){var c=b.schema;b=b.version;return b<=a&&c!=null}).reduce(function(a,b){b=b.schema;return Object.assign(a,b)},{})}f=k==null?void 0:k();f=l(Math.min(d("MAWDbSchema").MAW_DB_VERSION_CHANGES[d("MAWDbSchema").MAW_DB_VERSION_CHANGES.length-1].version,f!=null&&f>0?f:Infinity));function m(a,b){var c=b.schema,d=b.upgrade;b=b.version;c!=null&&d!=null?a.version(b).stores(c).upgrade(d):c!=null?a.version(b).stores(c):d!=null?a.version(b).upgrade(d):a.version(b);return b}function a(a,c){return d("MAWRestoreRewriteUtils").isOneDBEnabled()||c?(h||(h=b("Promise"))).resolve(null):new(h||(h=b("Promise")))(function(b){if(!indexedDB){b();return}var c=indexedDB.open(a);c.onsuccess=function(a){a=a.target.result;var c=a==null?void 0:a.version;a==null?void 0:a.close();c!=null?b(c/10):b()};c.onerror=function(){b()}})}function n(a,b){if(b.upgrade!=null)return!0;a=Object.keys((a==null?void 0:a.schema)||{});b=Object.keys((b==null?void 0:b.schema)||{});a=[].concat(a,b);b=new Set(a);return b.size!==a.length}function o(a){return a.reduce(function(a,b,c){if(c===0)return[babelHelpers["extends"]({},b,{schema:l(b.version)})];c=a[a.length-1];if(n(c,b)){a.push(b);return a}a.splice(a.length-1,1,babelHelpers["extends"]({},b,{schema:babelHelpers["extends"]({},c==null?void 0:c.schema,b.schema)}));return a},[])}function e(a,b,c){var e=null,f=c!=null?c:k==null?void 0:k();d("WALogger").DEV(j(),f);f==null&&d("WALogger").WARN(i());c=d("MAWDbSchema").MAW_DB_VERSION_CHANGES.filter(function(a){a=a.version;return b==null||a>b}).filter(function(a){a=a.version;return f==null||f>=a});var g=d("MAWDbSchema").MAW_DB_VERSION_CHANGES.filter(function(a){a=a.version;return f==null||f>=a});if(c.length===0||c.length===g.length){g=d("MAWDbSchema").MAW_DB_VERSION_CHANGES[d("MAWDbSchema").MAW_DB_VERSION_CHANGES.length-1].version;g=Math.min(f!=null&&f>0?f:g,g);a.version(g).stores(l(g));return}g=o(c);g.forEach(function(b){e=Math.max((b=m(a,b))!=null?b:0,(b=e)!=null?b:0)});return e}g.CURRENT_MAW_STORES=f;g.getDexieDbVersion=a;g.updateDB=e}),98);
__d("MAWDBRestoreConfig",["ReStoreDbConfigStore"],(function(a,b,c,d,e,f,g){"use strict";var h={lockVersion:9,name:d("ReStoreDbConfigStore").DB_CONFIG_KEY};function a(){return{defaultConfig:h,isEqual:function(a){return(a==null?void 0:a.lockVersion)==null?!1:(a==null?void 0:a.lockVersion)===h.lockVersion}}}g.createConfig=a}),98);
__d("MAWRestoreSchemaIndexedDB",["IndexedDbPolyfills","MAWCurrentUser","MAWDBRestoreConfig","MAWDbVersion","MAWIndexedDbMetadata","MAWReStoreDbSchema","Promise","ReStore","ReStoreIDBFactory","ReStoreMetadata","asyncToGeneratorRuntime","createReStoreIndexedDbPersistenceWithoutLocks","dexie_maw","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j={};function k(){return c("qex")._("285")}function a(){if(i==null){var a,e=d("ReStoreMetadata").getBuildTableData(j)([d("MAWReStoreDbSchema").clientSchema.map(function(a,b){return babelHelpers["extends"]({},a,{id:(b+1).toString()})})]),f=(a=k())!=null?a:0;i=c("ReStore")(c("createReStoreIndexedDbPersistenceWithoutLocks")(d("MAWIndexedDbMetadata").restoreDbName2(d("MAWCurrentUser").getID()),Object.keys(e.tableNames),d("MAWDBRestoreConfig").createConfig()),e,void 0,{migration:function(a,e){return new(h||(h=b("Promise")))(function(g,j){var k={open:function(){var c=new(d("IndexedDbPolyfills").IDBRequest)(),k=new(d("ReStoreIDBFactory").ReStoreIDBDatabase)(i,""),l=new(d("ReStoreIDBFactory").ReStoreIDBTransaction)(babelHelpers["extends"]({},i,{runInTransaction:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;try{b=(yield a(e))}catch(a){j(a);throw a}g();return b});function c(b){return a.apply(this,arguments)}return c}()}),k,new Set(k.objectStoreNames),"versionchange");c.result=k;c.transaction=l;void b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield (h||(h=b("Promise"))).resolve(),c.emit("upgradeneeded",{newVersion:f,oldVersion:a,target:{result:k,transaction:l}})})();return c}};k=new(c("dexie_maw"))("",{IDBKeyRange:d("ReStoreIDBFactory").ReStoreIDBKeyRange,chromeTransactionDurability:"relaxed",enableDataSyncMiddleware:!1,indexedDB:k,shimEnabled:!0});d("MAWDbVersion").updateDB(k,a,f);k.open()})},targetVersion:f})}return i}g.createDB=a}),98);